<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes">
    <title>Unity WebGL Player | vera_test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      html, body { 
        height: 100%; 
        margin: 0; 
        padding: 0;
        background: #000; 
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      #unity-container { 
        position: fixed; 
        width: 100%; 
        height: 100%; 
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
      }
      
      #unity-canvas { 
        width: 100%;
        height: 100%;
        display: block; 
        background: #000;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
      #unity-loading-bar {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 400px;
        text-align: center;
        color: white;
        background: rgba(0, 0, 0, 0.9);
        padding: 40px 30px;
        border-radius: 20px;
        border: 2px solid #0088cc;
        box-shadow: 0 10px 40px rgba(0, 136, 204, 0.3);
        z-index: 1000;
      }
      
      #unity-logo {
        width: 100px;
        height: 100px;
        margin: 0 auto 25px auto;
        background: linear-gradient(135deg, #0088cc, #00aaff);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: bold;
        color: white;
        animation: logoFloat 3s infinite ease-in-out;
        box-shadow: 0 10px 30px rgba(0, 136, 204, 0.4);
      }
      
      @keyframes logoFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-15px) rotate(5deg); }
      }
      
      .loading-text {
        font-size: 20px;
        margin-bottom: 25px;
        color: #fff;
        font-weight: 500;
      }
      
      #unity-progress-bar-empty {
        width: 100%;
        height: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      
      #unity-progress-bar-full {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #0088cc, #00aaff);
        border-radius: 10px;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      
      #unity-progress-bar-full::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: progressShine 1.5s infinite;
      }
      
      @keyframes progressShine {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      
      .progress-percent {
        font-size: 16px;
        color: #ccc;
        margin-top: 12px;
        font-weight: bold;
      }
      
      #unity-warning {
        position: fixed;
        left: 50%;
        top: 20px;
        transform: translateX(-50%);
        background: #cc0000;
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        display: none;
        z-index: 9999;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 5px 20px rgba(204, 0, 0, 0.3);
      }
      
      /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
      @media (max-width: 768px) {
        #unity-loading-bar {
          width: 85%;
          padding: 30px 20px;
        }
        
        #unity-logo {
          width: 80px;
          height: 80px;
          font-size: 28px;
        }
        
        .loading-text {
          font-size: 18px;
        }
      }
      
      /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
      @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -45%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
      }
      
      #unity-loading-bar {
        animation: fadeIn 0.5s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo">üéÆ</div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
        <div class="progress-percent" id="progress-percent">0%</div>
      </div>
      <div id="unity-warning"></div>
    </div>

    <script>
      // ===== –≠–õ–ï–ú–ï–ù–¢–´ =====
      const container = document.querySelector("#unity-container");
      const canvas = document.querySelector("#unity-canvas");
      const loadingBar = document.querySelector("#unity-loading-bar");
      const progressBarFull = document.querySelector("#unity-progress-bar-full");
      const progressPercent = document.querySelector("#progress-percent");
      const warningBanner = document.querySelector("#unity-warning");
      const loadingText = document.querySelector(".loading-text");

      // ===== –§–£–ù–ö–¶–ò–ò =====
      function unityShowBanner(msg, type) {
        console.log(`[UNITY ${type.toUpperCase()}] ${msg}`);
        
        const div = document.createElement('div');
        div.innerHTML = msg;
        
        if (type === 'error') {
          div.style.cssText = `
            background: #dc3545;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            border-left: 4px solid #ff6b6b;
          `;
        } else if (type === 'warning') {
          div.style.cssText = `
            background: #ffc107;
            color: #856404;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            border-left: 4px solid #ffd351;
          `;
          setTimeout(() => {
            try { warningBanner.removeChild(div); } catch(e) {}
          }, 5000);
        } else {
          div.style.cssText = `
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            border-left: 4px solid #34ce57;
          `;
        }
        
        warningBanner.appendChild(div);
        warningBanner.style.display = 'block';
      }

      function updateLoadingText(text) {
        if (loadingText) {
          loadingText.textContent = text;
        }
      }

      // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø UNITY =====
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Telegram.loader.js";
      const config = {
        dataUrl: buildUrl + "/Telegram.data",
        frameworkUrl: buildUrl + "/Telegram.framework.js",
        codeUrl: buildUrl + "/Telegram.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "vera_test",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
      function initialize() {
        console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ===');
        
        // –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
          container.className = "unity-mobile";
          canvas.className = "unity-mobile";
        } else {
          canvas.style.width = "100%";
          canvas.style.height = "100%";
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
        loadingBar.style.display = "block";
        updateLoadingText("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

        // –ó–∞–≥—Ä—É–∂–∞–µ–º Telegram WebApp
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
          try {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            console.log('Telegram WebApp –≥–æ—Ç–æ–≤');
          } catch (e) {
            console.warn('Telegram WebApp –æ—à–∏–±–∫–∞:', e);
          }
        }

        // –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç
        const script = document.createElement("script");
        script.src = loaderUrl;
        
        script.onload = () => {
          console.log('Loader –∑–∞–≥—Ä—É–∂–µ–Ω, —Å–æ–∑–¥–∞–µ–º Unity –∏–Ω—Å—Ç–∞–Ω—Å...');
          updateLoadingText("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
          
          createUnityInstance(canvas, config, (progress) => {
            const percent = Math.round(progress * 100);
            progressBarFull.style.width = percent + "%";
            progressPercent.textContent = percent + "%";
            
            if (progress < 0.3) {
              updateLoadingText("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...");
            } else if (progress < 0.7) {
              updateLoadingText("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...");
            } else if (progress < 1) {
              updateLoadingText("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...");
            } else {
              updateLoadingText("–ì–æ—Ç–æ–≤–æ!");
            }
            
          }).then((unityInstance) => {
            console.log('‚úÖ Unity —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            
            // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(() => {
              loadingBar.style.opacity = '0';
              loadingBar.style.transition = 'opacity 0.5s ease';
              setTimeout(() => {
                loadingBar.style.display = "none";
              }, 500);
            }, 500);
            
            window.unityInstance = unityInstance;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö Telegram –≤ Unity
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
              const user = Telegram.WebApp.initDataUnsafe.user;
              if (user) {
                unityInstance.SendMessage("WebAppBridge", "OnTelegramUserData", JSON.stringify({
                  id: user.id,
                  first_name: user.first_name,
                  username: user.username,
                  language_code: user.language_code
                }));
                console.log('‚úÖ Telegram –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Unity');
              } else {
                console.warn("Telegram user data not available");
              }
            } else {
              console.warn("Telegram WebApp not available (opened outside Telegram)");
            }

          }).catch((error) => {
            console.error("Unity initialization failed:", error);
            unityShowBanner("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message, "error");
            updateLoadingText("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
          });
        };

        script.onerror = () => {
          unityShowBanner("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫: " + loaderUrl, "error");
          updateLoadingText("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
        };

        document.body.appendChild(script);
      }

      // ===== –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ =====
      document.addEventListener('DOMContentLoaded', () => {
        // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
        setTimeout(initialize, 100);
      });

      // ===== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
      window.restartGame = function() {
        if (window.unityInstance) {
          window.unityInstance.Quit().then(() => {
            location.reload();
          });
        } else {
          location.reload();
        }
      };
    </script>
  </body>
</html>